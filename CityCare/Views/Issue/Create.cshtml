@model CityCare.Models.ViewModels.CreateIssueViewModel
@{
    ViewData["Title"] = "Report New Issue";
}

<div class="container py-4" style="max-width: 720px;">
    
    <div class="mb-4 text-center">
        <h2 class="fw-bold mb-1">Report an Issue</h2>
        <p class="text-muted">Help us improve the city by reporting problems you see.</p>
    </div>

    <!-- Updated background to light cream color from screenshot -->
    <div class="card shadow-sm border-0" style="background-color: #FAF7F0;">
        <div class="card-body p-4 p-lg-5">

            <form asp-action="Create" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                
                @if (!ViewData.ModelState.IsValid)
                {
                    <div class="alert alert-danger mb-4" role="alert">
                        <div asp-validation-summary="ModelOnly" class="mb-0"></div>
                    </div>
                }

                <h5 class="mb-3 text-secondary border-bottom pb-2">Issue Details</h5>

                <div class="mb-4">
                    <label class="form-label fw-semibold">Title</label>
                    <input asp-for="Title" class="form-control form-control-lg" placeholder="Briefly summarize the issue..." />
                    <span asp-validation-for="Title" class="text-danger small"></span>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Category</label>
                        <select asp-for="Category" class="form-select" id="Category">
                            <option value="">Select Category...</option>
                            @foreach (var c in ViewBag.Categories)
                            {
                                <option value="@c.Value">@c.Text</option>
                            }
                        </select>
                        <span asp-validation-for="Category" class="text-danger small"></span>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">City</label>
                        <select asp-for="CityId" class="form-select" id="CityId">
                            <option value="">Select City...</option>
                            @foreach (var city in ViewBag.Cities)
                            {
                                <option value="@city.Id">@city.Name</option>
                            }
                        </select>
                        <span asp-validation-for="CityId" class="text-danger small"></span>
                    </div>
                </div>

                <div class="mb-4 p-3 bg-light rounded border d-flex align-items-center" id="contactInfoBox" style="display:none;">
                    <div class="flex-grow-1">
                        <label class="small text-muted mb-1 d-block">Department Contact</label>
                        <div class="fw-bold" id="StaffPhoneDisplay">—</div>
                        <input type="hidden" id="StaffPhone" /> <!-- Hidden as we show it nicely above -->
                    </div>
                    <small id="StaffPhoneHelp" class="text-muted ms-2"></small>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-semibold">Location</label>
                    <input asp-for="LocationText" class="form-control" placeholder="Village, Street, or Landmark..." />
                    <div class="form-text">Be as specific as possible to help us locate the issue.</div>
                    <span asp-validation-for="LocationText" class="text-danger small"></span>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-semibold">Description</label>
                    <textarea asp-for="Description" class="form-control" rows="5"
                              placeholder="Describe the issue in detail. What is wrong? How does it affect the area?"></textarea>
                    <span asp-validation-for="Description" class="text-danger small"></span>
                </div>

                <h5 class="mt-5 mb-3 text-secondary border-bottom pb-2">Attachments</h5>

                <div class="mb-4">
                    <label class="form-label fw-semibold">Photo Evidence</label>
                    <input asp-for="ImageFile" type="file" class="form-control" accept="image/*" />
                    <div class="form-text">Supporting images help us prioritize and resolve issues faster. (JPG, PNG, WEBP)</div>
                    <span asp-validation-for="ImageFile" class="text-danger small"></span>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-5">
                    <a class="btn btn-light px-4" asp-action="Dashboard">Cancel</a>
                    <!-- Changed button class to custom style matching navbar -->
                    <button class="btn btn-primary px-5 fw-semibold shadow-sm">Submit Report</button>
                </div>
            </form>

        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            const categoryEl = document.getElementById('Category');
            const cityEl = document.getElementById('CityId');
            const phoneDisplayEl = document.getElementById('StaffPhoneDisplay');
            const helpEl = document.getElementById('StaffPhoneHelp');
            const contactBox = document.getElementById('contactInfoBox');

            async function loadPhone() {
                const category = categoryEl?.value;
                const cityId = cityEl?.value;

                phoneDisplayEl.textContent = '—';
                helpEl.textContent = '';
                
                // Only show box if something is selected, or always show it? 
                // Let's keep it visible so they know contact info appears here.

                if (!category || !cityId) {
                    phoneDisplayEl.textContent = 'Select Category & City to see contact';
                    return;
                }

                phoneDisplayEl.textContent = 'Loading...';

                try {
                    const url = `@Url.Action("LookupStaffPhone", "Issue")?category=${encodeURIComponent(category)}&cityId=${encodeURIComponent(cityId)}`;
                    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                    
                    if (!res.ok) {
                         phoneDisplayEl.textContent = 'Unavailable';
                         return;
                    }

                    const data = await res.json();
                    if (data && data.staffPhone) {
                        phoneDisplayEl.textContent = data.staffPhone;
                        helpEl.innerHTML = '<span class="badge bg-success">Available</span>';
                    } else {
                        phoneDisplayEl.textContent = 'Not Available';
                        helpEl.textContent = 'No contact number listed.';
                    }
                } catch {
                    phoneDisplayEl.textContent = 'Error';
                    helpEl.textContent = '';
                }
            }

            categoryEl?.addEventListener('change', loadPhone);
            cityEl?.addEventListener('change', loadPhone);

            // contactBox.style.display = 'block'; // Make sure it's visible if using js
            if(contactBox) contactBox.style.display = 'flex'; // Ensure flex since we used d-flex class but inline style might override

            // initial
            loadPhone();
        })();
    </script>
}
