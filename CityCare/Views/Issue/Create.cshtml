@model CityCare.Models.ViewModels.CreateIssueViewModel
@{
    ViewData["Title"] = "Report New Issue";
}

<div class="citizen-page">
    <div class="container" style="max-width: 860px;">
        
        <div class="text-center mb-4">
            <h1 class="page-title">Report an Issue</h1>
            <p class="page-subtitle">Help us improve the city by reporting problems you see.</p>
        </div>

        <div class="form-cc-container">

            <form asp-action="Create" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                
                @if (!ViewData.ModelState.IsValid)
                {
                    <div class="alert-cc error mb-4">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <div asp-validation-summary="ModelOnly" class="mb-0"></div>
                    </div>
                }

                <!-- Issue Details Section -->
                <h5 class="form-section-title">Issue Details</h5>

                <div class="mb-4">
                    <label asp-for="Title" class="form-label-cc">Title</label>
                    <input asp-for="Title" class="form-control-cc w-100" placeholder="Briefly summarize the issue..." />
                    <span asp-validation-for="Title" class="text-danger small"></span>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label asp-for="Category" class="form-label-cc">Category</label>
                        <select asp-for="Category" class="form-select-cc w-100" id="Category">
                            <option value="">Select Category...</option>
                            @foreach (var c in ViewBag.Categories)
                            {
                                <option value="@c.Value">@c.Text</option>
                            }
                        </select>
                        <span asp-validation-for="Category" class="text-danger small"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="CityId" class="form-label-cc">City</label>
                        <select asp-for="CityId" class="form-select-cc w-100" id="CityId">
                            <option value="">Select City...</option>
                            @foreach (var city in ViewBag.Cities)
                            {
                                <option value="@city.Id">@city.Name</option>
                            }
                        </select>
                        <span asp-validation-for="CityId" class="text-danger small"></span>
                    </div>
                </div>

                <!-- Department Contact Info Box -->
                <div class="info-box-cc mb-4" id="contactInfoBox" style="display:none;">
                    <div class="flex-grow-1">
                        <span class="info-label">Department Contact</span>
                        <div class="info-value" id="StaffPhoneDisplay">—</div>
                        <input type="hidden" id="StaffPhone" />
                    </div>
                    <small id="StaffPhoneHelp" class="text-muted ms-2"></small>
                </div>

                <div class="mb-4">
                    <label asp-for="LocationText" class="form-label-cc">Location</label>
                    <input asp-for="LocationText" class="form-control-cc w-100" placeholder="Village, Street, or Landmark..." />
                    <span class="form-text-cc">Be as specific as possible to help us locate the issue.</span>
                    <span asp-validation-for="LocationText" class="text-danger small"></span>
                </div>

                <div class="mb-4">
                    <label asp-for="Description" class="form-label-cc">Description</label>
                    <textarea asp-for="Description" class="form-control-cc w-100" rows="5"
                              placeholder="Describe the issue in detail. What is wrong? How does it affect the area?"></textarea>
                    <span asp-validation-for="Description" class="text-danger small"></span>
                </div>

                <!-- Attachments Section -->
                <h5 class="form-section-title">Attachments</h5>

                <div class="mb-4">
                    <label asp-for="ImageFile" class="form-label-cc">Photo Evidence</label>
                    <div class="file-upload-cc" onclick="document.getElementById('ImageFileInput').click();">
                        <span class="upload-icon">??</span>
                        <div class="upload-text">Click to upload or drag and drop</div>
                        <div class="upload-hint">JPG, PNG, WEBP (up to 10MB)</div>
                    </div>
                    <input type="file" id="ImageFileInput" asp-for="ImageFile" class="form-control" accept="image/*" style="display:none;" />
                    <span class="form-text-cc">Supporting images help us prioritize and resolve issues faster.</span>
                    <span asp-validation-for="ImageFile" class="text-danger small"></span>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex gap-2 justify-content-end mt-5">
                    <a class="btn btn-cc-outline" asp-action="Dashboard">Cancel</a>
                    <button type="submit" class="btn btn-cc-primary">
                        <i class="bi bi-send"></i> Submit Report
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            const categoryEl = document.getElementById('Category');
            const cityEl = document.getElementById('CityId');
            const phoneDisplayEl = document.getElementById('StaffPhoneDisplay');
            const helpEl = document.getElementById('StaffPhoneHelp');
            const contactBox = document.getElementById('contactInfoBox');
            const imageInput = document.getElementById('ImageFileInput');
            const fileUploadBox = document.querySelector('.file-upload-cc');

            // File upload drag and drop
            fileUploadBox.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadBox.style.borderColor = 'var(--yellow)';
                fileUploadBox.style.background = 'rgba(255, 196, 0, 0.12)';
            });

            fileUploadBox.addEventListener('dragleave', () => {
                fileUploadBox.style.borderColor = 'var(--border)';
                fileUploadBox.style.background = 'rgba(255, 196, 0, 0.03)';
            });

            fileUploadBox.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadBox.style.borderColor = 'var(--border)';
                fileUploadBox.style.background = 'rgba(255, 196, 0, 0.03)';
                if (e.dataTransfer.files.length > 0) {
                    imageInput.files = e.dataTransfer.files;
                }
            });

            // Update file name on selection
            imageInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    fileUploadBox.querySelector('.upload-text').textContent = e.target.files[0].name;
                }
            });

            async function loadPhone() {
                const category = categoryEl?.value;
                const cityId = cityEl?.value;

                phoneDisplayEl.textContent = '—';
                helpEl.textContent = '';

                if (!category || !cityId) {
                    phoneDisplayEl.textContent = 'Select Category & City to see contact';
                    return;
                }

                phoneDisplayEl.textContent = 'Loading...';

                try {
                    const url = `@Url.Action("LookupStaffPhone", "Issue")?category=${encodeURIComponent(category)}&cityId=${encodeURIComponent(cityId)}`;
                    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                    
                    if (!res.ok) {
                         phoneDisplayEl.textContent = 'Unavailable';
                         return;
                    }

                    const data = await res.json();
                    if (data && data.staffPhone) {
                        phoneDisplayEl.textContent = data.staffPhone;
                        helpEl.innerHTML = '<span class="badge-cc" style="background: #DCFCE7; color: #166534; border-color: #BBFBBB;"><i class="bi bi-check-circle"></i> Available</span>';
                    } else {
                        phoneDisplayEl.textContent = 'Not Available';
                        helpEl.textContent = 'No contact number listed.';
                    }
                } catch {
                    phoneDisplayEl.textContent = 'Error';
                    helpEl.textContent = '';
                }
            }

            categoryEl?.addEventListener('change', loadPhone);
            cityEl?.addEventListener('change', loadPhone);

            if(contactBox) contactBox.style.display = 'flex';
            loadPhone();
        })();
    </script>
}
